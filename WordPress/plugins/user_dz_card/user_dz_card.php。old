<?php
/**
 * @package User_DZ_Card
 * @version 1.0
 */
/*
Plugin Name: 评论用户浮动名片显示
Plugin URI: http://www.shanzhuoboshi.com/
Description: 在Wordpress和Discuz整合过程中，WP的评论用户头像部分也和DZ一样，出现浮动框，此插件就是实现这种功能
Author URI: http://www.shanzhuoboshi.com/
*/

//
function wp_get_card($display_name,$type,$wp_id=0){
	global $wpdb;
	$cardid = rand();

	$results_wp = $wpdb->get_results("SELECT * FROM ".$wpdb->prefix."users where display_name='".$display_name."'");

	//yangwen 2102-10-16
	if(function_exists('get_dz_datainfo')){
		$wpdb_dz = get_dz_datainfo();
	}else{
		//$errors->add('username_exists', __('<strong>ERROR</strong>: This username is already registered, please choose another one.'));
	}
	//yangwen 2102-10-16

	//yangwen 2012-10-19
	if(function_exists('get_dz_prefix')){
		//$dz_db_prefix = get_dz_prefix();
	}else{
		//$dz_db_prefix = 'pre_';
	}
	//yangwen 2012-10-19
	
	$customauthorinfo_results = $wpdb_dz->get_results("SELECT * FROM ".$dz_db_prefix."common_setting where skey='customauthorinfo'");
	$customauthorinfo = unserialize($customauthorinfo_results[0]->svalue);
	//var_dump($customauthorinfo);
	$results_wp_num = $wpdb->get_results("SELECT count(*) as c_num FROM ".$wpdb->prefix."comments where comment_author='".$display_name."'");
	$comment_num = $results_wp_num[0]->c_num;
	if($results_wp[0]->ID==null){//未注册用户
		$card_html = '<dl class="cl">';
		$card_html .= '<dt>博客评论</dt><dd>'.$comment_num.'</dd>';
		$card_html .= '<dt></dt><dd><font color="red">未注册用户</font></dd>';
		$card_html .= '</dl>';
		$img_html = get_avatar($results_wp[0]->ID,45);

	}else{
		$results = $wpdb_dz->get_results("SELECT * FROM ".$dz_db_prefix."common_member where username='".$results_wp[0]->user_login."'");
		if($results[0]->uid==null){
			$card_html = '<dl class="cl">';
			$card_html .= '<dt>博客评论</dt><dd>'.$comment_num.'</dd>';
			$card_html .= '<dt>注册时间</dt><dd>'.$results_wp[0]->user_registered.'</dd>';
			$card_html .= '</dl>';
			$img_html = get_avatar($results_wp[0]->ID,45);
		}else{
			$count_value_results = $wpdb_dz->get_results("SELECT * FROM ".$dz_db_prefix."common_member_count where uid=".$results[0]->uid );
			$member_value_results = $wpdb_dz->get_results("SELECT * FROM ".$dz_db_prefix."common_member_profile where uid=".$results[0]->uid );
			$member_key_results = $wpdb_dz->get_results("SELECT * FROM ".$dz_db_prefix."common_member_profile_setting where available=1" );
			$extcreditsinfo_results = $wpdb_dz->get_results("SELECT * FROM ".$dz_db_prefix."common_setting where skey='extcredits'");
			$extcreditsinfo = unserialize($extcreditsinfo_results[0]->svalue);
			$count_key = array(
				'uid'=>'UID',
				'friends'=>'好友',
				'doings'=>'记录',
				'blogs'=>'日志',
				'albums'=>'相册',
				'posts'=>'帖子',
				'threads'=>'主题',
				'sharings'=>'分享',
				'digest'=>'精华',
				'credits'=>'积分',
				'readperm'=>'阅读权限',
				'regtime'=>'注册时间',
				'lastdate'=>'最后登录',
				'oltime'=>'在线时间',
				'creditinfo'=>'信用度',
				'follower'=>'听众数',
				'following'=>'收听数',
				);
			foreach ( $extcreditsinfo as $extcreditskey=>$extcreditsvalue){
				$count_key['extcredits'.$extcreditskey] = $extcreditsvalue['title'];
			}
			foreach ( $member_key_results as $memberkey=>$membervalue){
				$member_key[$membervalue->fieldid] = $membervalue->title;
			}
			$readacc_results = $wpdb_dz->get_results("SELECT t1.readaccess as readacc FROM ".$dz_db_prefix."common_usergroup_field as t1,".$dz_db_prefix."common_member as t2 where t2.uid=".$results[0]->uid." and t1.groupid = t2.groupid" );
			$count_value['readperm'] = $readacc_results[0]->readacc;
			$lastdate_results = $wpdb_dz->get_results("SELECT lastvisit FROM ".$dz_db_prefix."common_member_status where uid=".$results[0]->uid);
			$count_value['lastdate'] = date("Y-m-d",$lastdate_results[0]->lastvisit);

			foreach ( $customauthorinfo[0] as $key=>$value){
				if(array_key_exists('menu',$value)){
					$member_keys = str_replace("field_","",$key);
					if($count_value_results[0]->$key!=''){
						if($key == 'creditinfo'){
							$vv = '<a href="home.php?mod=space&uid='.$post['uid'].'&do=trade&view=eccredit#buyercredit" target="_blank" class="vm"><img src="'.STATICURL.'image/traderank/seller/'.countlevel($post['buyercredit']).'.gif" />';
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;'.$count_value_results[0]->$key.'<br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = $count_value_results[0]->$key;
						}elseif($key == 'oltime'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;'.$count_value_results[0]->$key.'小时<br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = $count_value_results[0]->$key.'小时';
						}elseif($key == 'friends'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=friend&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=friend&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'doings'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=doing&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=doing&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'blogs'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=blog&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=blog&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'albums'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=album&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=album&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'sharings'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=share&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=share&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'follower'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=follow&do=follower&uid='.$member_value_results[0]->uid.'" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=follow&do=follower&uid='.$member_value_results[0]->uid.'" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'following'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=follow&do=following&uid='.$member_value_results[0]->uid.'" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=follow&do=following&uid='.$member_value_results[0]->uid.'" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'posts'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=thread&type=reply&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=thread&type=reply&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key == 'threads'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=thread&type=thread&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a><br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = '<a href="'.$dz_host.'/home.php?mod=space&uid='.$member_value_results[0]->uid.'&do=thread&type=thread&view=me&from=space" target="_blank">'.$count_value_results[0]->$key.'</a>';
						}elseif($key != 'birthyear'||$key != 'birthmonth'){
							//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;'.$count_value_results[0]->$key.'<br />';
							$html_skey[$key] = $count_key[$key];
							$html_svalue[$key] = $count_value_results[0]->$key;
						}
					}
					if($key =='readperm'&&$count_value['readperm']!=''){
						//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;'.$count_value['readperm'].'<br />';
						$html_skey[$key] = $count_key[$key];
						$html_svalue[$key] = $count_value['readperm'];
					}
					if($key =='lastdate'&&$count_value['lastdate']!=''){
						//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;'.$count_value['lastdate'].'<br />';
						$html_skey[$key] = $count_key[$key];
						$html_svalue[$key] = $count_value['lastdate'];
					}
					if($key =='creditinfo'&&$count_value['creditinfo']!=''){
						//$card_html .= '&nbsp;&nbsp;'.$count_key[$key].'&nbsp;&nbsp;'.$count_value['creditinfo'].'<br />';
						$html_skey[$key] = $count_key[$key];
						$html_svalue[$key] = $count_value['creditinfo'];
					}
					if($member_value_results[0]->$member_keys!=''){
						if($key == 'field_birthday'){
							$vv = $member_value_results[0]->birthyear.'年'.$member_value_results[0]->birthmonth.'月';
							//$card_html .= '&nbsp;&nbsp;'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$vv.'<br />';
							$html_skey[$key] = $member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $vv;
						}elseif($key == 'field_birthcity'){
							$vv = $member_value_results[0]->birthprovince.$member_value_results[0]->birthcity.$member_value_results[0]->birthdist.$member_value_results[0]->birthcommunity;
							//$card_html .= '&nbsp;&nbsp;'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$vv.'<br />';
							$html_skey[$key] = $member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $vv;
						}elseif($key == 'field_residecity'){
							$vv = $member_value_results[0]->resideprovince.$member_value_results[0]->residecity.$member_value_results[0]->residedist.$member_value_results[0]->birthcommunity;
							//$card_html .= '&nbsp;&nbsp;'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$vv.'<br />';
							$html_skey[$key] = $member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $vv;
						}elseif($key == 'field_gender'){
							$vv = $member_value_results[0]->gender=='0'?'保密':($member_value_results[0]->gender==1?'男':'女');
							//$card_html .= '&nbsp;&nbsp;'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$vv.'<br />';
							$html_skey[$key] = $member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $vv;
						}elseif($key == 'field_qq'){
							//$card_html .= '&nbsp;&nbsp;<a href="http://wpa.qq.com/msgrd?V=1&Uin='.$member_value_results[0]->qq.'&Site=shanzhuoboshi&Menu=yes" target="_blank" title="QQ"><img src="'.$dz_host.'/static/image/common/connect_qq.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$member_value_results[0]->qq.'<br />';
							$html_skey[$key] = '<a href="http://wpa.qq.com/msgrd?V=1&Uin='.$member_value_results[0]->qq.'&Site=shanzhuoboshi&Menu=yes" target="_blank" title="QQ"><img src="'.$dz_host.'/static/image/common/connect_qq.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $member_value_results[0]->qq;
						}elseif($key == 'field_icq'){
							//$card_html .= '&nbsp;&nbsp;<a href="http://wwp.icq.com/scripts/search.dll?to='.$member_value_results[0]->icq.'" target="_blank" title="icq"><img src="'.$dz_host.'/static/image/common/icq.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$member_value_results[0]->icq.'<br />';
							$html_skey[$key] = '<a href="http://wwp.icq.com/scripts/search.dll?to='.$member_value_results[0]->icq.'" target="_blank" title="icq"><img src="'.$dz_host.'/static/image/common/icq.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $member_value_results[0]->icq;
						}elseif($key == 'field_yahoo'){
							//$card_html .= '&nbsp;&nbsp;<a href="http://edit.yahoo.com/config/send_webmesg?.target='.$member_value_results[0]->yahoo.'" target="_blank" title="QQ"><img src="'.$dz_host.'/static/image/common/yahoo.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$member_value_results[0]->yahoo.'<br />';
							$html_skey[$key] = '<a href="http://edit.yahoo.com/config/send_webmesg?.target='.$member_value_results[0]->yahoo.'" target="_blank" title="QQ"><img src="'.$dz_host.'/static/image/common/yahoo.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $member_value_results[0]->yahoo;
						}elseif($key == 'field_taobao'){
							//$card_html .= '&nbsp;&nbsp;<a href="javascript:;" onclick="window.open(\'http://amos.im.alisoft.com/msg.aw?v=2&uid=\'+encodeURIComponent(\''.$member_value_results[0]->taobao.'\')+\'&site=cntaobao&s=2&charset=utf-8\')" title="阿里旺旺'.$member_value_results[0]->taobao.'" target="_blank" title="taobao"><img src="'.$dz_host.'/static/image/common/taobao.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$member_value_results[0]->taobao.'<br />';
							$html_skey[$key] = '<a href="javascript:;" onclick="window.open(\'http://amos.im.alisoft.com/msg.aw?v=2&uid=\'+encodeURIComponent(\''.$member_value_results[0]->taobao.'\')+\'&site=cntaobao&s=2&charset=utf-8\')" title="阿里旺旺'.$member_value_results[0]->taobao.'" target="_blank" title="taobao"><img src="'.$dz_host.'/static/image/common/taobao.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $member_value_results[0]->taobao;
						}elseif($key == 'field_site'){
							//$card_html .= '&nbsp;&nbsp;<a href="'.$member_value_results[0]->site.'" target="_blank" title="site"><img src="'.$dz_host.'/static/image/common/forumlink.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$member_value_results[0]->site.'<br />';
							$html_skey[$key] = '<a href="'.$member_value_results[0]->site.'" target="_blank" title="site"><img src="'.$dz_host.'/static/image/common/forumlink.gif" width="16" height="16" /></a>'.$member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $member_value_results[0]->site;
						}elseif($key != 'field_birthprovince'&&$key != 'field_birthdist'&&$key != 'field_birthcommunity'&&$key != 'field_resideprovince'&&$key != 'field_residedist'&&$key != 'field_birthcommunity'&&$key != 'uid'&&$key != 'field_birthmonth'&&$key != 'field_birthyear'){
							//$card_html .= '&nbsp;&nbsp;'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$member_value_results[0]->$member_keys.'<br />';
							$html_skey[$key] = $member_key[str_replace("field_","",$key)];
							$html_svalue[$key] = $member_value_results[0]->$member_keys;
						}
					}
				}
			}

			$card_html = '<dl class="cl">';
			$card_html .= '<dt>博客评论</dt><dd>'.$comment_num.'</dd>';
			$card_html .= '<dt>注册时间</dt><dd>'.$results_wp[0]->user_registered.'</dd>';

			foreach ( $customauthorinfo[0] as $key=>$value){
				if(array_key_exists('menu',$value)&&$html_svalue[$key]!=''){
					$card_html .= '<dt>'.$html_skey[$key].'</dt><dd>'.$html_svalue[$key].'</dd>';
					//$card_html .= '&nbsp;&nbsp;'.$member_key[str_replace("field_","",$key)].'&nbsp;&nbsp;'.$member_value_results[0]->$member_keys.'<br />';
				}
			}
			$card_html .= '</dl>';
			$card_html .='<div class="imicn">';
			$card_html .= '<a href="'.$dz_host.'/home.php?mod=space&uid='.$results[0]->uid.'&do=profile" target="_blank" title="查看详细资料"><img src="'.$dz_host.'/static/image/feed/profile.gif" alt="查看详细资料" />查看资料</a>&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$results[0]->uid.'&do=profile&pwoption=haoyou"  target="_blank" ><img src="'.$dz_host.'/static/image/feed/friend.gif" width="16" height="16" />加为好友</a>&nbsp;&nbsp;<a href="'.$dz_host.'/home.php?mod=space&uid='.$results[0]->uid.'&do=profile&pwoption=xiaoxi" target="_blank" ><img src="'.$dz_host.'/static/image/feed/pm.gif" width="16" height="16" />发送消息</a>&nbsp;&nbsp;<a href="/szbstest/dz25/home.php?mod=space&uid=5&do=wall" target="_blank" ><img src="'.$dz_host.'/static/image/feed/wall.gif" width="16" height="16" />给他留言</a></div>';
			$img_html = "<img alt='' src='".$dz_host."/uc_server/avatar.php?uid=".$results[0]->uid."&size=small' class='avatar  photo' />";
		}
		
	}

	

	$div_html ='<span  style="position:relative;">';
	$div_html .='<div class="clear"></div>';
	$div_html .='<div class="p_pop_'.$type.' blk bui_'.$type.'" id="userinfo'.$cardid.'" style="display: none; margin-top: -11px;">';
	$div_html .='<div class="m z">';
	$div_html .='<div id="userinfo'.$cardid.'_ma"></div>';
	$div_html .='</div>';
	$div_html .='<div class="i y">';
	if($type){
		$div_html .='<div>';
		$div_html .='<strong><a href="'.$dz_host.'/home.php?mod=space&uid='.$results[0]->uid.'" target="_blank" class="xi2">'.$display_name.'</a></strong>';
		$div_html .='<em>&nbsp;&nbsp;'.$card_html_author.'</em>';
		$div_html .='</div>';
	}
	$div_html .= $card_html;
	$div_html .='<div id="avatarfeed"><span id="threadsortswait"></span></div>';
	$div_html .='</div>';
	$div_html .='</div>';
	if($type){
		$div_html .='<span onmouseover="showauthor(this, \'userinfo'.$cardid.'\')">';
		$div_html .= $img_html;
		$div_html .='</span>';
	}else{
		$div_html .='<span onmouseover="showauthor(this, \'userinfo'.$cardid.'\')">';
		$div_html .='<a href="'.$dz_host.'/home.php?mod=space&uid='.$results[0]->uid.'" target="_blank">'.$display_name.'</a>';
		$div_html .='</span>';
	}
	$div_html .='</span>';
	

	return $div_html;

}//end func

//
function load_card_css(){
	return '<link rel="stylesheet" href="wp-content/plugins/user_dz_card/user_card.css" type="text/css" />';
}//end func

?>
